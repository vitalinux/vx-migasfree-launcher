#!/bin/bash
_FIRST=/var/tmp/migasfree/first-tags.conf
_USER=`python -c "from migasfree_client import utils;print utils.get_graphic_user(utils.get_graphic_pid()[0])"`

_PYTHON_CODE="from migasfree_client.utils import get_config
from migasfree_client import settings
config = get_config(settings.CONF_FILE, 'client')
print config.get('server', 'localhost')
"
_SERVER=$(python -c "$_PYTHON_CODE")


# Install broadcom 43xx without inet
if [ -f $_FIRST ] ; then
  lspci -n | awk '{print $3}' | grep "14e4:43"
  if [ $? = 0 ] ; then
    echo "----------------------------"
    echo "Instalando broadcom-43XX ..."
    dpkg -i /opt/pkgs/b43-fwcutter_*.deb
    dpkg -i /opt/pkgs/vx-broadcom-43_*.deb
  fi
fi


# Wait inet connection (3 minutes max.)
let _retries=0
until wget -O /tmp/inet_connection $_SERVER &> /dev/null
do
    if [ $_retries -le 18 ] ; then
      sleep 10 # 18*10" = 3 min.
      let _retries=_retries+1
      echo $_retries
    else
      # No hay conexiÃ³n al servidor y salimos.
      echo "--------------------------------"
      echo "No hay conexion con $_SERVER_SOURCE_LIST. Se cancela el primer arranque."
      exit 1
    fi
done
rm /tmp/inet_connection

# Check and get key "migasfree-repository"
apt-key list|grep uid|grep 'migasfree-repository' > /dev/null
if [ $? == 1 ] ; then
    echo "Obteniendo la clave publica de los repositorios del servidor: $_SERVER"
    wget -qO - $_SERVER/get_key_repositories | apt-key add -
fi


# block update-notifier
chmod 000 /etc/xdg/autostart/update-notifier.desktop || :


if [ -f $_FIRST ] ; then
  _TAGS="$(cat $_FIRST)"
  if [ -z $_TAGS ] ; then
    _TAGS='""'
  fi
  if [ "$SUDO_UID" = "999" ] ; then # Se esta probando el LiveCD
    echo "--------------------------------"
    echo "Instalando formatos  restrictivos ..."
    /usr/bin/restrictedformats
  else
    echo "--------------------------------"
    echo "Configurando sabor: $_TAGS"
    /usr/bin/migasfree-tags --set $_TAGS
    echo "--------------------------------"
    echo "Instalando formatos  restrictivos ..."
    /usr/bin/restrictedformats
    mv $_FIRST $_FIRST.save
    echo "--------------------------------"

  fi
else
  echo "--------------------------------"
  echo "Actualizando el sistema ..."
  /usr/bin/migasfree --update
  echo "--------------------------------"
fi

# run update-notifier
if [ -f /usr/bin/update-notifier ] ; then
  sleep 5
  exec su --login -c "/usr/bin/update-notifier --force-use-gksu" $_USER &> /dev/null &
fi
