#!/bin/bash
_FIRST=/var/tmp/migasfree/first-tags.conf
_USER=`python -c "from migasfree_client import utils;print utils.get_graphic_user(utils.get_graphic_pid()[0])"`

#_SERVER_SOURCE_LIST="http://softlibre.unizar.es/ubuntu/archive"
_SERVER_SOURCE_LIST="http://archive.ubuntu.com/ubuntu"

function create_source_list(){
    local _SRV=$1
    cat > /etc/apt/sources.list<<EOF
deb $_SRV precise main restricted
deb $_SRV precise-updates main restricted
deb $_SRV precise universe
deb $_SRV precise-updates universe
deb $_SRV precise multiverse
deb $_SRV precise-updates multiverse
deb $_SRV precise-security restricted main multiverse universe
EOF

}


# Install broadcom 43xx without inet
if [ -f $_FIRST ] ; then
  lspci -n | awk '{print $3}' | grep "14e4:43"
  if [ $? = 0 ] ; then
    dpkg -i /opt/pkgs/b43-fwcutter_*.deb
    dpkg -i /opt/pkgs/vx-broadcom-43_*.deb
    sleep 10
  fi
fi


# Check Server
wget -O /tmp/server_repositories $_SERVER_SOURCE_LIST &> /dev/null
if [ $? != 0 ] ; then
  # No hay conexiÃ³n al servidor y salimos.
  exit 1
fi


# block update-notifier
mv /etc/xdg/autostart/update-notifier.desktop /etc/xdg/autostart/update-notifier.desktop.migasfree-launcher  &> /dev/null || :

# sources.list
create_source_list $_SERVER_SOURCE_LIST

if [ -f $_FIRST ] ; then
  _TAGS="$(cat $_FIRST)"
  if [ -z $_TAGS ] ; then
    _TAGS="''"
  fi
  if [ "$SUDO_UID" = "999" ] ; then # Se esta probando el LiveCD
    /usr/bin/restrictedformats
  else
    /usr/bin/migasfree-tags --set $_TAGS
    /usr/bin/restrictedformats
    mv $_FIRST $_FIRST.save
  fi
else
  /usr/bin/migasfree --update
fi

# run update-notifier
if [ -f /usr/bin/update-notifier ] ; then
  su -c "/usr/bin/update-notifier" $_USER &
fi
