#!/bin/bash
_FIRST=/var/tmp/migasfree/first-tags.conf
_USER=`python -c "from migasfree_client import utils;print utils.get_graphic_user(utils.get_graphic_pid()[0])"`

function create_source_list(){
    rm /etc/apt/sources.list
    cat >>/etc/apt/sources.list<<EOF
deb http://softlibre.unizar.es/ubuntu/archive precise main restricted
deb http://softlibre.unizar.es/ubuntu/archive precise-updates main restricted
deb http://softlibre.unizar.es/ubuntu/archive precise universe
deb http://softlibre.unizar.es/ubuntu/archive precise-updates universe
deb http://softlibre.unizar.es/ubuntu/archive precise multiverse
deb http://softlibre.unizar.es/ubuntu/archive precise-updates multiverse
EOF
}


# block update-notifier
mv /etc/xdg/autostart/update-notifier.desktop /etc/xdg/autostart/update-notifier.desktop.migasfree-launcher >/dev/null || :

if [ -f $_FIRST ] ; then
  create_source_list
  _TAGS="$(cat $_FIRST)"
  if [ -z $_TAGS ] ; then
    _TAGS="''"
  fi
  if [ "$SUDO_UID" = "999" ] ; then # Se esta probando el LiveCD
    /usr/bin/restrictedformats
  else
    xterm -iconic -T "COMPLETANDO LA INSTALACION..." -e "/usr/bin/migasfree-tags --set $_TAGS"
    /usr/bin/restrictedformats
    rm -f $_FIRST
  fi
else
  /usr/bin/migasfree --update
fi

# run update-notifier
if [ -f /usr/bin/update-notifier ] ; then
  su -c "/usr/bin/update-notifier" $_USER &
fi
